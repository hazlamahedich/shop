name: PR Validation

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  validate:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11.7'

      - name: Install pre-commit
        run: pip install pre-commit

      - name: Run pre-commit on changed files
        run: |
          git diff --name-only --diff-filter=ACM origin/main | xargs pre-commit run --files

      - name: Check PR title
        run: |
          TITLE="${{ github.event.pull_request.title }}"
          if [[ ! "$TITLE" =~ ^(feat|fix|docs|style|refactor|test|chore)(\(.+\))?:.+ ]]; then
            echo "❌ PR title should follow conventional commits"
            echo "   Examples: feat: add new feature"
            echo "             fix(auth): resolve login bug"
            exit 1
          fi

      - name: Check for TODO comments
        run: |
          if git diff --name-only origin/main | xargs grep -l "TODO" 2>/dev/null; then
            echo "⚠️  TODO comments found in changes"
            echo "   Please create issues for TODOs instead"
          fi

      - name: Check test colocation
        run: |
          python scripts/validate_test_colocation.py || true
