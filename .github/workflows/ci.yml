name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

permissions:
  contents: read
  security-events: write
  actions: read

jobs:
  backend:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_DB: shop_test
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

      redis:
        image: redis:7
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11.7'
          cache: 'pip'

      - name: Install dependencies
        run: |
          cd backend
          pip install -e ".[test,dev]"
          pip list

      - name: Lint with ruff
        run: |
          cd backend
          ruff check .

      - name: Security scan with Bandit
        run: |
          cd backend
          pip install bandit[toml]
          bandit -r app/ -f json -o bandit-report.json || true
          bandit -r app/ -ll
        continue-on-error: true

      - name: Upload Bandit security report
        uses: github/codeql-action/upload-sarif@v2
        if: always()
        with:
          sarif_file: backend/bandit-report.json
          category: bandit

      - name: Dependency vulnerability scan with Safety
        run: |
          cd backend
          pip install safety
          safety check --json --output safety-report.json || true
          safety check
        continue-on-error: true

      - name: Format check with black
        run: |
          cd backend
          black --check .

      - name: Type check with mypy
        run: |
          cd backend
          mypy app/ || true  # Don't fail on type errors yet

      - name: Run tests
        env:
          DATABASE_URL: postgresql+asyncpg://test:test@localhost:5432/shop_test
          REDIS_URL: redis://localhost:6379/0
          IS_TESTING: "true"
        run: |
          cd backend
          pytest --cov=app --cov-report=xml --cov-report=term

      - name: Upload coverage
        uses: codecov/codecov-action@v3
        with:
          files: ./backend/coverage.xml
          flags: backend

      - name: Contract tests
        env:
          DATABASE_URL: postgresql+asyncpg://test:test@localhost:5432/shop_test
          IS_TESTING: "true"
        run: |
          cd backend
          pytest tests/contract/ || true  # Don't fail if no endpoints yet

  frontend:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        run: |
          cd frontend
          npm ci

      - name: Type check
        run: |
          cd frontend
          npm run type-check || true  # May not exist yet

      - name: Lint with eslint
        run: |
          cd frontend
          npm run lint || true  # May not exist yet

      - name: Security audit npm dependencies
        run: |
          cd frontend
          npm audit --audit-level=high --json > npm-audit-report.json || true
          npm audit --audit-level=high
        continue-on-error: true

      - name: Upload npm audit report
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: npm-audit-report
          path: frontend/npm-audit-report.json

      - name: Format check with prettier
        run: |
          cd frontend
          npm run format:check || true  # May not exist yet

      - name: Run tests
        run: |
          cd frontend
          npm test || true  # May not exist yet

  validate-hooks:
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11.7'

      - name: Install pre-commit
        run: pip install pre-commit

      - name: Run pre-commit hooks
        run: pre-commit run --all-files

  type-generation:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: backend

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11.7'

      - name: Install dependencies
        run: |
          cd backend
          pip install -e .

      - name: Generate types
        run: |
          python scripts/generate_types.py || true  # May fail if no app yet

      - name: Check types generated
        run: |
          if [ -f "frontend/src/lib/types/generated.ts" ]; then
            echo "✅ TypeScript types generated"
          else
            echo "⚠️  TypeScript types not yet generated (app may not be ready)"
          fi
